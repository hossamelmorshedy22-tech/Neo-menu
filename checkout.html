<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>إتمام الطلب — Neo Café</title>
  <style>
    body{margin:0;font-family:system-ui,'Noto Sans Arabic',sans-serif;background:#E9DCC9;color:#111}
    .container{max-width:720px;margin:24px auto;padding:16px}
    .card{background:#fff;padding:16px;border-radius:12px;border:1px solid rgba(0,0,0,0.04)}
    .field{margin-bottom:12px}
    label{display:block;font-weight:800;color:#0D615B;margin-bottom:6px}
    input[type="text"],input[type="date"],select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd}
    .btn{display:inline-block;padding:12px 14px;border-radius:10px;background:#0D615B;color:#fff;text-decoration:none;font-weight:800;border:none;cursor:pointer}
    .btn.secondary{background:#fff;color:#0D615B;border:2px solid #0D615B}
    .summary{margin-top:12px;background:#f8f8f8;padding:12px;border-radius:8px}
    .small{font-size:13px;color:#666}
    .order-list{margin:10px 0;padding-left:18px}
    .order-list li{margin-bottom:6px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    @media (max-width:600px){
      .container{padding:12px}
      .actions{flex-direction:column-reverse}
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 style="color:#0D615B">إتمام الطلب</h2>

    <div id="no-cart" class="card" style="display:none">
      لم يتم العثور على عناصر في السلة. <a href="index.html">عودة للمنيو</a>
    </div>

    <div id="checkout-card" class="card" style="display:none">
      <div class="field">
        <label for="name">الاسم</label>
        <input id="name" type="text" placeholder="اكتب اسمك">
      </div>

      <div class="field">
        <label for="dob">تاريخ الميلاد</label>
        <input id="dob" type="date">
      </div>

      <div class="field">
        <label for="table">رقم الطاولة</label>
        <select id="table">
          <option value=''>اختر رقم الطاولة</option>
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
        </select>
      </div>

      <div class="field">
        <label for="notes">ملاحظات إضافية (اختياري)</label>
        <textarea id="notes" rows="3" placeholder="مثال: بدون سكر / زيادة لبن"></textarea>
      </div>

      <div id="order-summary" class="summary"></div>

      <div class="actions">
        <button id="back" class="btn secondary" onclick="window.location.href='index.html'">تعديل السلة</button>
        <button id="send" class="btn">إرسال الطلب</button>
      </div>
    </div>
  </div>

  <script>
  (function(){

    const CART_KEY = 'neo_cart_v3';

    // load cart from localStorage
    function loadCart(){
      try{ return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); }catch(e){ return []; }
    }

    function renderSummary(){
      const cart = loadCart();
      const noCart = document.getElementById('no-cart');
      const checkoutCard = document.getElementById('checkout-card');
      const summary = document.getElementById('order-summary');

      if(!cart || cart.length === 0){
        noCart.style.display = 'block';
        checkoutCard.style.display = 'none';
        return;
      }

      noCart.style.display = 'none';
      checkoutCard.style.display = 'block';

      let total = 0;
      let html = '<div style="font-weight:800;margin-bottom:6px">الطلبات:</div>';
      html += '<ul class="order-list">';
      cart.forEach(i=>{
        const lineTotal = i.price * i.qty;
        total += lineTotal;
        html += `<li>• ${escapeHTML(i.name)} × ${i.qty} = ${lineTotal} ج</li>`;
      });
      html += '</ul>';
      html += `<div style="font-weight:900;color:#0D615B">المجموع: ${total} ج</div>`;
      summary.innerHTML = html;
    }

    // simple HTML escaper to be safe
    function escapeHTML(s){
      if(!s) return '';
      return String(s).replace(/[&<>"]/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]; });
    }

    // init render
    renderSummary();

    // SEND handler (robust)
    document.getElementById('send').addEventListener('click', function(){
      try {
        const cart = loadCart();
        const name = document.getElementById('name').value.trim();
        const dob  = document.getElementById('dob').value;
        const table = document.getElementById('table').value;
        const notes = document.getElementById('notes').value.trim();

        if(!name){ alert('من فضلك اكتب الاسم'); return; }
        if(!dob){ alert('من فضلك اختر تاريخ الميلاد'); return; }
        if(!table){ alert('من فضلك اختار رقم الطاولة'); return; }
        if(!cart || cart.length === 0){ alert('السلة فارغة'); return; }

        // compute totals & items text
        let total = 0;
        let itemsText = '';
        cart.forEach(i => {
          const line = `${i.name} × ${i.qty} = ${i.price * i.qty} ج`;
          itemsText += `- ${line}\n`;
          total += i.price * i.qty;
        });

        // build formatted message (each part on its own line)
        let msg =
          `طلب من: Neo Café\n` +
          `الاسم: ${name}\n` +
          `تاريخ الميلاد: ${dob}\n` +
          `رقم الطاولة: ${table}\n\n` +
          `الطلبات:\n` + itemsText + `\n` +
          `المجموع: ${total} ج\n`;

        if(notes) msg += `\nملاحظات:\n${notes}\n`;

        // whatsapp number: Egypt 01034311119 -> country code 20
        const waNumber = '201034311119';
        const waUrl = 'https://wa.me/' + waNumber + '?text=' + encodeURIComponent(msg);

        // optional: remove cart from storage after preparing link
        try{ localStorage.removeItem(CART_KEY); }catch(e){ console.warn('could not clear cart', e); }

        // open in new tab to avoid some popup blockers; fallback to location.href
        const win = window.open(waUrl, '_blank');
        if(!win){
          // popup blocked -> fallback
          window.location.href = waUrl;
        } else {
          try{ win.focus(); }catch(e){}
        }

      } catch(err){
        console.error('Send handler error:', err);
        alert('حصل خطأ أثناء إرسال الطلب — جرب مرة تانية.');
      }
    });

  })();
  </script>
</body>
</html>
