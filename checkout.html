<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ â€” Neo CafÃ©</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;800&display=swap" rel="stylesheet">
<style>
  :root{--primary:#125433;--light:#f7f5f1}
  body{font-family: "Cairo", sans-serif; background:var(--light); margin:0; padding:20px}
  .container{max-width:760px;margin:20px auto;background:#fff;border-radius:16px;padding:22px;box-shadow:0 6px 30px rgba(0,0,0,0.08)}
  h2{text-align:center;color:var(--primary);margin:0 0 18px}
  label{display:block;margin-top:14px;font-weight:700;color:#333}
  input, select, textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #e0e0e0;margin-top:6px;font-size:15px;box-sizing:border-box}
  .row{display:flex;gap:10px}
  .row .col{flex:1}
  .cart-box{background:#fafafa;border-radius:12px;padding:14px;margin-bottom:14px;border:1px solid #eee}
  #cart-items{min-height:60px}
  .cart-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #eee}
  .small-btn{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer}
  #send-order{width:100%;padding:14px;border-radius:12px;border:none;background:var(--primary);color:#fff;font-size:18px;margin-top:16px;cursor:pointer}
  #send-order:active{transform:translateY(1px)}
  .loyal-wrap{display:none;background:#f6fffa;border:1px solid #d8f3e6;padding:10px;border-radius:10px;margin-top:12px;color:#0a6b3f}
  .loyal-progress{font-weight:700;margin-top:6px}
  .footer-note{text-align:center;color:#666;font-size:14px;margin-top:12px}
  .empty-note{color:#777;padding:10px}
  .cart-actions{display:flex;gap:8px;align-items:center}
  @media (max-width:520px){ .row{flex-direction:column} .cart-row{flex-direction:column;align-items:flex-start} .cart-actions{margin-top:8px} }
</style>
</head>
<body>

<div class="container">
  <h2>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</h2>

  <div class="cart-box">
    <h3 style="margin:0 0 8px">Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø³Ù„Ø©:</h3>
    <div id="cart-items"></div>
    <p style="margin-top:12px"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: </strong><span id="total">0</span> Ø¬Ù†ÙŠÙ‡</p>
  </div>

  <label>Ø§Ù„Ø§Ø³Ù…:</label>
  <input id="cust-name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§">

  <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯:</label>
  <div class="row">
    <div class="col">
      <select id="dob-day"><option selected disabled>Ø§Ù„ÙŠÙˆÙ…</option></select>
    </div>
    <div class="col">
      <select id="dob-month"><option selected disabled>Ø§Ù„Ø´Ù‡Ø±</option></select>
    </div>
    <div class="col">
      <select id="dob-year"><option selected disabled>Ø§Ù„Ø³Ù†Ø©</option></select>
    </div>
  </div>

  <label>Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©:</label>
  <select id="cust-table">
    <option selected disabled>Ø§Ø®ØªØ§Ø± Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©</option>
  </select>

  <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„:</label>
  <input id="phone" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù…Ùƒ">

  <!-- loyalty UI area -->
  <div id="loyal-status" class="loyal-wrap" aria-live="polite">
    <div id="loyal-msg">Ù†Ù‚Ø§Ø· Ø§Ù„ÙˆÙ„Ø§Ø¡: 0 / 5</div>
    <div id="loyal-progress" class="loyal-progress">Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…: â—‹â—‹â—‹â—‹â—‹</div>
    <div style="margin-top:8px">
      <button id="redeem-free" class="small-btn" style="display:none;background:var(--primary);color:#fff;border:none">Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù…Ø´Ø±ÙˆØ¨ Ù…Ø¬Ù‘Ø§Ù†ÙŠ</button>
    </div>
    <div style="margin-top:8px;font-size:13px;color:#444">Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆÙ„Ø§Ø¡: ÙƒÙ„ Ø·Ù„Ø¨ = Ù†Ø¬Ù…Ø©. Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù€ 5 Ù†Ø¬ÙˆÙ… ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ù…Ø´Ø±ÙˆØ¨ Ù…Ø¬Ø§Ù†ÙŠ.</div>
  </div>

  <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</label>
  <textarea id="notes" placeholder="Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø·Ù„Ø¨ Ù…Ø¹ÙŠÙ† Ø§ÙƒØªØ¨Ù‡ Ù‡Ù†Ø§"></textarea>

  <button id="send-order">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>

  <div class="footer-note">Ù‚Ù‡ÙˆØ© Ù…Ù…ÙŠØ²Ø©ØŒ Ø£Ø¬ÙˆØ§Ø¡ Ù‡Ø§Ø¯ÙŠØ© â€” ØªØ¹Ø§Ù„ Ø¬Ø±Ø¨ Ø¨Ù†ÙØ³Ùƒ. Øª: 01034311119</div>
</div>

<!-- ========================= -->
<!-- Firebase + Firestore module (system uses doc id = normalized phone) -->
<!-- ========================= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    runTransaction
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBPMOhuvKn6mUNgHYMiN9F_6m0ikmriOA4",
    authDomain: "neo-loyalty-b41c7.firebaseapp.com",
    projectId: "neo-loyalty-b41c7",
    storageBucket: "neo-loyalty-b41c7.firebasestorage.app",
    messagingSenderId: "1024912015862",
    appId: "1:1024912015862:web:8647e752c9ea2d2085c7d7",
    measurementId: "G-BKZPWB7YS6"
  };

  // init firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);

  // helpers
  function normalizePhoneRaw(v){
    if(!v) return '';
    const digits = (''+v).replace(/\D+/g,'');
    if(digits.length === 0) return '';
    // if starts with country code 20 => convert to 0...
    if(digits.startsWith('20') && digits.length >= 11) return '0' + digits.slice(2);
    if(digits.startsWith('0')) return digits;
    if(digits.length === 10 && digits.startsWith('1')) return '0' + digits;
    return digits;
  }

  // Firestore functions
  async function incrementStampOnServer(rawPhone){
    const phone = normalizePhoneRaw(rawPhone || '');
    if(!phone) return {ok:false, msg:'invalid phone'};
    const ref = doc(db, 'customers', phone);
    try{
      const result = await runTransaction(db, async (tx) => {
        const snap = await tx.get(ref);
        let data = { points:0, rewards:0, last: Date.now() };
        if(snap.exists()){
          data = snap.data();
          data.points = Number(data.points || 0);
          data.rewards = Number(data.rewards || 0);
        }
        data.points = (data.points || 0) + 1;
        data.last = Date.now();
        let rewardGranted = false;
        if(data.points >= 5){
          data.points = 0;
          data.rewards = (data.rewards || 0) + 1;
          rewardGranted = true;
        }
        tx.set(ref, data, { merge:true });
        return { data, rewardGranted };
      });
      const { data, rewardGranted } = result;
      if(rewardGranted){
        const congratMsg = `ğŸ‰ Ø§Ù†Øª Ù…Ù† Ø¹Ù…Ù„Ø§Ø¡ Ù†ÙŠÙˆ ÙƒØ§ÙÙŠÙ‡ Ø§Ù„Ù…Ù…ÙŠØ²ÙŠÙ†\nÙƒØ³Ø¨Øª Ù…Ø´Ø±ÙˆØ¨ Ù…Ø¬Ø§Ù†ÙŠ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø±Ùƒ ğŸ’š\nØ¨Ù†Ø´ÙƒØ±Ùƒ Ø¹Ù„Ù‰ Ø«Ù‚ØªÙƒ ÙÙŠÙ†Ø§ ÙˆØ¨Ù†ØªÙ…Ù†Ù‰ Ù†ÙƒÙˆÙ† Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¹Ù†Ø¯ Ø­Ø³Ù† Ø¸Ù†Ùƒ ÙÙŠÙ†Ø§.`;
        return { ok:true, reward:true, entry:data, congratMsg };
      }
      return { ok:true, reward:false, entry:data };
    }catch(err){
      console.error(err);
      return { ok:false, msg:err.message || 'tx failed' };
    }
  }

  async function getLoyaltyStatus(rawPhone){
    const phone = normalizePhoneRaw(rawPhone || '');
    if(!phone) return {ok:false, msg:'invalid phone'};
    try{
      const snap = await getDoc(doc(db, 'customers', phone));
      if(!snap.exists()) return { ok:true, entry: { points:0, rewards:0 } };
      return { ok:true, entry: snap.data() };
    }catch(err){
      console.error(err);
      return { ok:false, msg: err.message || 'get failed' };
    }
  }

  async function redeemOnServer(rawPhone){
    const phone = normalizePhoneRaw(rawPhone || '');
    if(!phone) return {ok:false, msg:'invalid phone'};
    const ref = doc(db, 'customers', phone);
    try{
      const out = await runTransaction(db, async (tx) => {
        const snap = await tx.get(ref);
        if(!snap.exists()) throw new Error('no entry');
        const data = snap.data();
        const rewards = Number(data.rewards || 0);
        if(rewards <= 0) throw new Error('no rewards');
        data.rewards = rewards - 1;
        data.last = Date.now();
        tx.set(ref, data, { merge: true });
        return data;
      });
      return { ok:true, entry: out };
    }catch(err){
      console.error(err);
      return { ok:false, msg: err.message || 'redeem failed' };
    }
  }

  // expose minimal API to window
  window._neoFirebase = {
    incrementStampOnServer,
    getLoyaltyStatus,
    redeemOnServer,
    normalizePhoneRaw
  };

</script>

<!-- ========================= -->
<!-- Scripts: cart handling, UI binding, send-order -->
<!-- ========================= -->
<script>
/* -------------- init DOB & tables -------------- */
(function initSelects(){
  const day = document.getElementById('dob-day');
  const month = document.getElementById('dob-month');
  const year = document.getElementById('dob-year');
  for(let i=1;i<=31;i++) day.appendChild(new Option(i,i));
  for(let i=1;i<=12;i++) month.appendChild(new Option(i,i));
  const yNow = new Date().getFullYear();
  for(let y=yNow-10; y>= yNow-80; y--) year.appendChild(new Option(y,y));
  const table = document.getElementById('cust-table');
  for(let t=1;t<=10;t++) table.appendChild(new Option(t,t));
})();

/* -------------- cart functions (load, render, edit) -------------- */
/* robust load with multiple keys + fallback */
function readCartFromStorage(){
  const possibleKeys = ['cart','neo_cart','cartItems','cart_items'];
  let raw = null;
  for(const k of possibleKeys){
    const v = localStorage.getItem(k);
    if(v && v !== 'null'){ raw = v; break; }
  }
  if(!raw){
    for(const k of possibleKeys){
      const v = sessionStorage.getItem(k);
      if(v && v !== 'null'){ raw = v; break; }
    }
  }
  if(!raw) return [];
  try{
    let cart = JSON.parse(raw);
    if(!Array.isArray(cart) && typeof cart === 'object'){
      if(cart.items && Array.isArray(cart.items)) cart = cart.items;
      else cart = Object.keys(cart).map(k => cart[k]).filter(Boolean);
    }
    return cart;
  }catch(e){
    console.warn('cart parse failed', e);
    return [];
  }
}

function saveCartToStorage(cart){
  try{
    const json = JSON.stringify(cart || []);
    // keep multiple keys updated for compatibility
    localStorage.setItem('cart', json);
    localStorage.setItem('neo_cart', json);
    localStorage.setItem('cartItems', json);
    localStorage.setItem('cart_items', json);
  }catch(e){ console.warn('saveCart fail', e); }
}

function renderCart(){
  const list = document.getElementById("cart-items");
  const totalEl = document.getElementById("total");
  if(!list || !totalEl) return;
  const cart = readCartFromStorage();
  list.innerHTML = "";
  if(!cart || cart.length === 0){
    list.innerHTML = '<div class="empty-note">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ© â€” Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù†ÙŠÙˆ</div>';
    totalEl.textContent = 0;
    return;
  }
  let sum = 0;
  cart.forEach((item, index) => {
    const qty = Number(item.qty || 1);
    const price = Number(item.price || 0);
    const row = document.createElement("div");
    row.className = "cart-row";
    row.dataset.index = index;
    row.innerHTML = `
      <div style="flex:1">
        <div style="font-weight:700">${item.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</div>
        <div style="font-size:13px;color:#666">${price} Ø¬ Ã— ${qty}</div>
      </div>
      <div class="cart-actions">
        <button data-index="${index}" class="cart-minus small-btn">-</button>
        <div style="min-width:26px;text-align:center">${qty}</div>
        <button data-index="${index}" class="cart-plus small-btn">+</button>
        <button data-index="${index}" class="cart-remove small-btn" style="color:#b00">Ø­Ø°Ù</button>
      </div>
    `;
    list.appendChild(row);
    sum += price * qty;
  });
  totalEl.textContent = sum;
}

/* delegate events for cart buttons */
(function attachCartDelegation(){
  const list = document.getElementById('cart-items');
  if(!list) return;
  list.addEventListener('click', function(ev){
    const t = ev.target;
    const idx = t.getAttribute && t.getAttribute('data-index');
    if(idx === null) return;
    const i = Number(idx);
    const cart = readCartFromStorage();
    if(!cart[i]) return;
    if(t.classList.contains('cart-plus')){
      cart[i].qty = Number(cart[i].qty || 1) + 1;
    } else if(t.classList.contains('cart-minus')){
      cart[i].qty = Math.max(1, Number(cart[i].qty || 1) - 1);
    } else if(t.classList.contains('cart-remove')){
      cart.splice(i,1);
    } else return;
    saveCartToStorage(cart);
    renderCart();
    // update loyalty status if needed
    showLoyalStatusUI();
  });
})();

// initial render
renderCart();

/* -------------- Loyalty UI binding & handlers -------------- */

const DEST_WHATSAPP = '201034311119'; // Ø±Ù‚Ù… Neo Cafe Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ø¨Ø¯Ù‘Ù„ Ù„Ùˆ Ø¹Ø§ÙŠØ²)

async function showLoyalStatusUI(){
  try{
    const phoneEl = document.getElementById('phone');
    const wrap = document.getElementById('loyal-status');
    const msg = document.getElementById('loyal-msg');
    const progress = document.getElementById('loyal-progress');
    const redeemBtn = document.getElementById('redeem-free');
    if(!phoneEl) return;
    const raw = phoneEl.value || '';
    const norm = window._neoFirebase.normalizePhoneRaw(raw);
    if(!norm){
      if(wrap) wrap.style.display = 'none';
      return;
    }
    const res = await window._neoFirebase.getLoyaltyStatus(norm);
    if(!res || !res.ok){
      if(wrap) wrap.style.display = 'none';
      return;
    }
    const entry = res.entry || { points:0, rewards:0 };
    if(wrap){
      wrap.style.display = 'block';
      if(msg) msg.innerText = `Ù†Ù‚Ø§Ø· Ø§Ù„ÙˆÙ„Ø§Ø¡: ${entry.points} / 5  â€” ${entry.rewards > 0 ? 'Ù„Ø¯ÙŠÙƒ Ù…Ø´Ø±ÙˆØ¨ Ù…Ø¬Ø§Ù†ÙŠ Ù…ØªØ§Ø­!' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ù…Ø¬Ø§Ù†ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹'}`;
      if(progress) progress.innerText = `Ø§Ù„ØªÙ‚Ø¯Ù‘Ù…: ${'â—'.repeat(entry.points)}${'â—‹'.repeat(Math.max(0,5-entry.points))}`;
      if(redeemBtn) redeemBtn.style.display = entry.rewards > 0 ? 'inline-block' : 'none';
    }
  }catch(err){
    console.warn('showLoyalStatusUI error', err);
  }
}

(function attachPhoneListener(){
  const phoneEl = document.getElementById('phone');
  if(!phoneEl) return;
  phoneEl.addEventListener('input', () => {
    if(phoneEl._timer) clearTimeout(phoneEl._timer);
    phoneEl._timer = setTimeout(()=> { showLoyalStatusUI(); }, 300);
  });
  // initial
  showLoyalStatusUI();
})();

/* -------------- send-order handler (increment loyalty then open whatsapp) -------------- */

(function attachSendHandler(){
  const sendBtn = document.getElementById('send-order');
  if(!sendBtn) return;
  sendBtn.addEventListener('click', async function(e){
    e.preventDefault();
    const name = (document.getElementById('cust-name') || {value:''}).value.trim();
    const phoneRaw = (document.getElementById('phone') || {value:''}).value.trim();
    const phone = window._neoFirebase.normalizePhoneRaw(phoneRaw);
    const table = (document.getElementById('cust-table') || {value:''}).value;
    const notes = (document.getElementById('notes') || {value:''}).value.trim();
    const d = document.getElementById('dob-day') ? document.getElementById('dob-day').value : '';
    const m = document.getElementById('dob-month') ? document.getElementById('dob-month').value : '';
    const y = document.getElementById('dob-year') ? document.getElementById('dob-year').value : '';
    const dob = (d||m||y) ? `${d || '-'}-${m || '-'}-${y || '-'}` : '-';

    if(!phone || phone.length < 8){
      alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØµØ§Ù„Ø­ (Ù…Ù‡Ù… Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆÙ„Ø§Ø¡)');
      document.getElementById('phone').focus();
      return;
    }

    // 1) update loyalty atomically on server
    const inc = await window._neoFirebase.incrementStampOnServer(phone);
    if(inc && inc.ok && inc.reward){
      // user got reward: show dialog
      alert(inc.congratMsg || 'ğŸ‰ Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ù…Ø´Ø±ÙˆØ¨ Ù…Ø¬Ø§Ù†ÙŠ â€” Ù…Ø¨Ø±ÙˆÙƒ!');
    }

    // 2) prepare cart lines
    const cart = readCartFromStorage();
    let lines = [];
    lines.push(`Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Neo CafÃ©`);
    lines.push(`------------------------`);
    lines.push(`Ø§Ù„Ø§Ø³Ù…: ${name || '-'}`);
    lines.push(`ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: ${dob}`);
    lines.push(`Ø±Ù‚Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©: ${table || '-'}`);
    lines.push(`Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„: ${phone}`);
    lines.push(`------------------------`);
    lines.push(`Ø§Ù„Ø£ØµÙ†Ø§Ù:`);
    if(!cart || cart.length === 0){
      lines.push('- Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù');
    } else {
      cart.forEach(it => {
        const qty = Number(it.qty || 1);
        const price = Number(it.price || 0);
        const priceText = price === 0 ? '0 Ø¬ (Ù…Ø¬Ø§Ù†ÙŠ)' : `${price} Ø¬`;
        lines.push(`â€¢ ${it.name} Ã— ${qty} = ${priceText}`);
      });
    }
    lines.push(`------------------------`);
    if(notes) lines.push(`Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${notes}`);
    // loyalty snapshot
    const st = await window._neoFirebase.getLoyaltyStatus(phone);
    if(st && st.ok){
      const e = st.entry || { points:0, rewards:0 };
      lines.push(`------------------------`);
      lines.push(`Ø­Ø§Ù„Ø© Ø§Ù„ÙˆÙ„Ø§Ø¡: ${e.points}/5 ØŒ Ø¬ÙˆØ§Ø¦Ø² Ù…ØªØ§Ø­Ø©: ${e.rewards}`);
    }
    lines.push('');
    lines.push(`Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø®ØªÙŠØ§Ø±Ùƒ Neo CafÃ© â€” Make It NEO Time`);

    // 3) open whatsapp with encoded message
    const msg = encodeURIComponent(lines.join('\n'));
    window.open(`https://api.whatsapp.com/send?phone=${DEST_WHATSAPP}&text=${msg}`, '_blank');

    // 4) refresh UI (re-render cart & loyalty)
    setTimeout(()=>{ renderCart(); showLoyalStatusUI(); }, 600);
  });
})();

/* -------------- redeem handler (Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¨ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ) -------------- */
(function attachRedeem(){
  const redeemBtn = document.getElementById('redeem-free');
  if(!redeemBtn) return;
  redeemBtn.addEventListener('click', async function(){
    const phone = (document.getElementById('phone')||{value:''}).value.trim();
    const norm = window._neoFirebase.normalizePhoneRaw(phone);
    if(!norm){ alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹'); return; }
    const s = await window._neoFirebase.getLoyaltyStatus(norm);
    if(!s.ok){ alert('Ø­ØµÙ„ Ø®Ø·Ø£ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© ØªØ§Ù†ÙŠØ©'); return; }
    if((s.entry && s.entry.rewards || 0) <= 0){ alert('Ù…Ø¹Ù†Ø¯ÙƒØ´ Ù…Ø´Ø±ÙˆØ¨ Ù…Ø¬Ø§Ù†ÙŠ Ø§Ù„Ø¢Ù†'); return; }
    // simple redeem flow: ask for product name
    const product = prompt('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¨ Ø§Ù„Ù„ÙŠ Ø¹Ø§ÙŠØ² ØªØ³ØªØ¨Ø¯Ù„Ù‡ (Ù…Ø«Ø§Ù„: Ø§Ø³Ø¨Ø±ÙŠØ³Ùˆ)').trim();
    if(!product){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø´Ø±ÙˆØ¨'); return; }
    // call redeem on server
    const res = await window._neoFirebase.redeemOnServer(norm);
    if(!res.ok){ alert('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„'); return; }
    // add free item to cart
    const cart = readCartFromStorage();
    cart.push({ name: product + ' (Ù…Ø¬Ø§Ù†ÙŠ)', price: 0, qty: 1, free:true });
    saveCartToStorage(cart);
    renderCart();
    showLoyalStatusUI();
    alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${product} Ù…Ø¬Ø§Ù†Ù‹Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©.`);
  });
})();

/* -------------- ensure initial UI tied up -------------- */
window.addEventListener('load', function(){
  renderCart();
  showLoyalStatusUI();
});
</script>
</body>
</html>
 
