<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEO Cafe - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„ÙƒØ§Ø´ÙŠØ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary: #124d33;
            --secondary: #d4af37;
            --bg: #f4f7f6;
            --white: #ffffff;
            --danger: #e74c3c;
            --success: #2ecc71;
            --dark: #2c3e50;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar {
            width: 250px; background: var(--primary); color: var(--white);
            display: flex; flex-direction: column; padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar h2 { margin-bottom: 30px; text-align: center; color: var(--secondary); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        .nav-btn {
            background: none; border: none; color: var(--white); padding: 15px;
            text-align: right; font-size: 16px; cursor: pointer; transition: 0.3s;
            border-radius: 8px; margin-bottom: 5px; font-weight: 600;
        }
        .nav-btn:hover, .nav-btn.active { background: rgba(255,255,255,0.1); color: var(--secondary); border-right: 4px solid var(--secondary); }

        /* Main Content */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        .screen { display: none; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* POS Grid */
        .pos-container { display: flex; gap: 20px; height: calc(100vh - 40px); }
        .menu-area { flex: 2; overflow-y: auto; padding-right: 10px; }
        .cart-area { flex: 1; background: var(--white); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        
        .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .table-btn {
            padding: 20px; background: var(--white); border: 2px solid #ddd; border-radius: 10px;
            cursor: pointer; text-align: center; font-weight: bold; transition: 0.3s; position: relative;
        }
        .table-btn.occupied { background: #ffecec; border-color: var(--danger); color: var(--danger); }
        .table-btn.selected { background: var(--primary); color: var(--white); border-color: var(--primary); }

        .cat-tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; }
        .cat-tab { padding: 8px 15px; background: var(--white); border-radius: 20px; cursor: pointer; border: 1px solid #ddd; white-space: nowrap; }
        .cat-tab.active { background: var(--primary); color: var(--white); }

        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
        .pos-card {
            background: var(--white); padding: 10px; border-radius: 10px; text-align: center;
            cursor: pointer; border: 1px solid #eee; transition: 0.2s;
        }
        .pos-card:hover { transform: translateY(-3px); border-color: var(--secondary); }
        .pos-card img { width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-bottom: 5px; }
        .pos-card h4 { font-size: 13px; margin-bottom: 3px; }
        .pos-card span { color: var(--primary); font-weight: bold; font-size: 12px; }

        /* Cart */
        .cart-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .cart-items { flex: 1; overflow-y: auto; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
        .cart-total { margin-top: auto; padding-top: 15px; border-top: 2px solid #eee; }
        .total-row { display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; margin-bottom: 15px; }
        .btn-checkout { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-checkout:hover { background: #0e3d28; }

        /* Inventory & Tables */
        .data-table { width: 100%; border-collapse: collapse; background: var(--white); border-radius: 8px; overflow: hidden; }
        .data-table th, .data-table td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; }
        .data-table th { background: #f8f9fa; font-weight: 700; color: var(--dark); }
        .input-box { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
        
        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-right: 4px solid var(--primary); }
        .stat-card h3 { color: var(--muted); font-size: 14px; margin-bottom: 5px; }
        .stat-card .val { font-size: 24px; font-weight: 800; color: var(--dark); }

        /* Printing (Receipt) - Hidden on Screen */
        #receipt-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #receipt-area, #receipt-area * { visibility: visible; }
            #receipt-area {
                position: absolute; left: 0; top: 0; width: 100%; display: block;
                font-family: 'Courier New', monospace; text-align: center;
                width: 78mm; /* Standard Thermal Paper */
                margin: 0 auto;
                padding: 10px;
                color: black;
            }
            .r-header img { width: 60px; filter: grayscale(100%); }
            .r-table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 12px; }
            .r-table th { border-bottom: 1px dashed #000; padding: 5px 0; }
            .r-table td { padding: 5px 0; }
            .r-total { border-top: 1px dashed #000; padding-top: 10px; font-weight: bold; font-size: 14px; margin-top: 10px; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>NEO Admin</h2>
        <button class="nav-btn active" onclick="showScreen('pos')">ğŸ›’ Ø§Ù„ÙƒØ§Ø´ÙŠØ± (Ø¨ÙŠØ¹)</button>
        <button class="nav-btn" onclick="showScreen('dashboard')">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­</button>
        <button class="nav-btn" onclick="showScreen('inventory')">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù† (Ø®Ø§Ù…Ø§Øª)</button>
        <button class="nav-btn" onclick="showScreen('recipes')">âš™ï¸ Ø¶Ø¨Ø· Ø§Ù„ØªÙƒÙ„ÙØ©</button>
        <div style="margin-top:auto">
            <button class="nav-btn" style="background:#e74c3c" onclick="exportData()">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© (Excel)</button>
        </div>
    </div>

    <div class="main-content">
        
        <div id="pos" class="screen active">
            <div class="pos-container">
                <div class="menu-area">
                    <h3>1. Ø§Ø®ØªØ± Ø§Ù„ØªØ±Ø§Ø¨ÙŠØ²Ø©</h3>
                    <div class="tables-grid" id="tablesGrid"></div>
                    
                    <h3 style="margin-top:20px;display:flex;justify-content:space-between">
                        2. Ø§Ù„Ù…Ù†ÙŠÙˆ
                        <input type="text" id="searchProd" placeholder="Ø¨Ø­Ø«..." style="font-size:12px;padding:5px;width:150px">
                    </h3>
                    <div class="cat-tabs" id="catTabs"></div>
                    <div class="products-grid" id="productsGrid"></div>
                </div>

                <div class="cart-area">
                    <div class="cart-header">
                        <span id="currentTableLabel">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ØªØ±Ø§Ø¨ÙŠØ²Ø©</span>
                        <button onclick="clearCart()" style="color:red;background:none;border:none;cursor:pointer">Ù…Ø³Ø­</button>
                    </div>
                    <div class="cart-items" id="cartItems">
                        <div style="text-align:center;color:#999;margin-top:50px">Ø§Ø®ØªØ± ØªØ±Ø§Ø¨ÙŠØ²Ø© Ø«Ù… Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Øª</div>
                    </div>
                    <div class="cart-total">
                        <div class="total-row">
                            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                            <span id="cartTotal">0.00 Ø¬</span>
                        </div>
                        <button class="btn-checkout" onclick="checkout()">ğŸ–¨ï¸ Ø¥ØªÙ…Ø§Ù… ÙˆØ¯ÙØ¹ (Ø·Ø¨Ø§Ø¹Ø©)</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard" class="screen">
            <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
                    <div class="val" id="todaySales">0 Ø¬</div>
                </div>
                <div class="stat-card">
                    <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙˆØ±Ø¯Ø±Ø§Øª</h3>
                    <div class="val" id="todayOrders">0</div>
                </div>
                <div class="stat-card">
                    <h3>Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ… (ØªÙ‚Ø¯ÙŠØ±ÙŠ)</h3>
                    <div class="val" style="color:var(--success)" id="todayProfit">0 Ø¬</div>
                </div>
                <div class="stat-card">
                    <h3>Ø±ØµÙŠØ¯ Ø§Ù„Ø®Ø²Ù†Ø©</h3>
                    <div class="val" id="safeBalance">0 Ø¬</div>
                </div>
            </div>

            <div style="background:white;padding:20px;border-radius:10px;margin-top:20px">
                <h3>Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h3>
                <table class="data-table">
                    <thead><tr><th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„ØªØ±Ø§Ø¨ÙŠØ²Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th></tr></thead>
                    <tbody id="salesLogBody"></tbody>
                </table>
            </div>
        </div>

        <div id="inventory" class="screen">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²Ù† ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…</h2>
                <button onclick="addRawMaterial()" style="padding:10px 20px;background:var(--secondary);border:none;border-radius:5px;cursor:pointer;font-weight:bold">Ø¥Ø¶Ø§ÙØ© Ø®Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© +</button>
            </div>
            <table class="data-table">
                <thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ø®Ø§Ù…Ø©</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø­Ø°Ù</th></tr></thead>
                <tbody id="inventoryBody"></tbody>
            </table>
        </div>

        <div id="recipes" class="screen">
            <h2>Ø¶Ø¨Ø· Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„Ù…Ù‚Ø§Ø¯ÙŠØ± (Ù„Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ø®ØµÙ…)</h2>
            <p style="color:#666;font-size:13px;margin-bottom:20px">Ù‡Ù†Ø§ Ø¨ØªØ­Ø¯Ø¯ ØªÙƒÙ„ÙØ© ÙƒÙ„ Ù…Ù†ØªØ¬ Ø¹Ø´Ø§Ù† ØªØ­Ø³Ø¨ Ø§Ù„Ø±Ø¨Ø­ØŒ ÙˆØ¨ØªØ®ØªØ§Ø± Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ù„ÙŠ ØªØªØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù† Ù„Ù…Ø§ ØªØ¨ÙŠØ¹Ù‡.</p>
            <input type="text" id="recipeSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." class="input-box" style="margin-bottom:15px">
            <table class="data-table">
                <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th><th>Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© (Ù„Ù„Ø±Ø¨Ø­)</th><th>ÙŠØ®ØµÙ… Ù…Ù† (Ø®Ø§Ù…Ø©)</th><th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø®ØµÙˆÙ…Ø©</th><th>Ø­ÙØ¸</th></tr></thead>
                <tbody id="recipesBody"></tbody>
            </table>
        </div>

    </div>

    <div id="receipt-area">
        <div class="r-header">
            <img src="assets/images/logo.png" alt="NEO">
            <h3>NEO Cafe</h3>
            <p>Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ…</p>
            <p id="r-date">Date</p>
            <p id="r-id">Order #</p>
        </div>
        <hr style="border-top: 1px dashed #000;">
        <table class="r-table">
            <thead><tr><th style="text-align:right">Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø¹Ø¯Ø¯</th><th>Ø§Ù„Ø³Ø¹Ø±</th></tr></thead>
            <tbody id="r-items"></tbody>
        </table>
        <div class="r-total">
            Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="r-total-price">0.00</span> Ø¬
        </div>
        <div style="margin-top:15px;font-size:12px">Ø´Ø±ÙØªÙ†Ø§ ÙŠØ§ Ø¨ÙˆØ¨!</div>
    </div>

<script>
// --- 1. DATA INITIALIZATION ---
// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ù†ÙØ³ Ø¨Ù†ÙŠØ© Ù…Ù„Ù Ø§Ù„Ù…Ù†ÙŠÙˆ)
const MENU_DATA = {
  ramadan: { title: 'Ø±Ù…Ø¶Ø§Ù†', items: [
      {id:'ram_01', name:'Ø±Ø² Ø¨Ù„Ø¨Ù† Ù…ÙƒØ³Ø±Ø§Øª', price:40}, {id:'ram_02', name:'Ø±Ø² Ø¨Ù„Ø¨Ù† ÙƒØ±Ø§Ù…ÙŠÙ„', price:45},
      {id:'ram_03', name:'Ø±Ø² Ø¨Ù„Ø¨Ù† Ø´ÙˆÙƒÙ„Ø§ØªÙ‡', price:45}, {id:'ram_04', name:'Ø±Ø² Ø¨Ù„Ø¨Ù† Ù†ÙˆØªÙŠÙ„Ø§', price:55},
      {id:'ram_05', name:'Ø±Ø² Ø¨Ù„Ø¨Ù† Ø¨Ø³ØªØ§Ø´ÙŠÙˆ', price:60}, {id:'ram_06', name:'Ø±Ø² Ø¨Ù„Ø¨Ù† Ù„ÙˆØªØ³', price:55},
      {id:'ram_07', name:'Ø±Ø² Ø¨Ù„Ø¨Ù† Ù…ÙŠÙƒØ³', price:75}, {id:'ram_08', name:'Ø±Ø² Ø¨Ù„Ø¨Ù† Ù‚Ù†Ø¨Ù„Ø©', price:85},
      {id:'ram_09', name:'ÙƒÙØ¨ ÙƒÙ†Ø§ÙÙ‡ Ù„ÙˆØªØ³', price:85}, {id:'ram_10', name:'ÙƒÙØ¨ ÙƒÙ†Ø§ÙÙ‡ Ù†ÙˆØªÙŠÙ„Ø§', price:85},
      {id:'ram_11', name:'ÙØ§Ø¯Ø¬ ÙƒØ±Ø§Ù†Ø´ÙŠ', price:95}, {id:'ram_12', name:'ÙØ§Ø¯Ø¬ Ø¨Ø³ØªØ§Ø´ÙŠÙˆ', price:110}
  ]},
  hot: { title: 'Ø³Ø§Ø®Ù†', items: [
      {id:'hot_01', name:'Ø´Ø§ÙŠ', price:15}, {id:'hot_09', name:'Ø§Ø³Ø¨Ø±ÙŠØ³Ùˆ Ø³Ù†Ø¬Ù„', price:35},
      {id:'hot_10', name:'Ø§Ø³Ø¨Ø±ÙŠØ³Ùˆ Ø¯Ø¨Ù„', price:40}, {id:'hot_11', name:'Ù‚Ù‡ÙˆØ© ØªØ±ÙƒÙŠ', price:25},
      {id:'hot_13', name:'Ù‚Ù‡ÙˆØ© ÙØ±Ù†Ø³Ø§ÙˆÙŠ', price:35}, {id:'hot_17', name:'Ù„Ø§ØªÙŠÙ‡', price:50},
      {id:'hot_20', name:'ÙƒØ§Ø¨ØªØ´ÙŠÙ†Ùˆ', price:55}, {id:'hot_21', name:'Ù†Ø³ÙƒØ§ÙÙŠÙ‡', price:45},
      {id:'hot_26', name:'Ø³Ø­Ù„Ø¨', price:40}, {id:'hot_31', name:'Ø³Ø­Ù„Ø¨ Ù†ÙŠÙˆ', price:65}
  ]},
  cold: { title: 'Ø¨Ø§Ø±Ø¯', items: [
      {id:'ms_01', name:'Ù…ÙŠÙ„Ùƒ Ø´ÙŠÙƒ ÙØ§Ù†ÙŠÙ„Ø§', price:50}, {id:'ms_02', name:'Ù…ÙŠÙ„Ùƒ Ø´ÙŠÙƒ Ø§ÙˆØ±ÙŠÙˆ', price:55},
      {id:'ice_01', name:'Ø§ÙŠØ³ Ù„Ø§ØªÙŠÙ‡', price:50}, {id:'ice_04', name:'Ø§ÙŠØ³ Ø³Ø¨Ø§Ù†Ø´', price:65},
      {id:'frs_01', name:'Ù…Ø§Ù†Ø¬Ùˆ ÙØ±ÙŠØ´', price:50}, {id:'frs_06', name:'Ù„ÙŠÙ…ÙˆÙ†', price:30}
  ]},
  dessert: { title: 'Ø¯ÙŠØ²ÙŠØ±Øª', items: [
      {id:'dess_01', name:'ÙˆØ§ÙÙ„ Ø´ÙˆÙƒÙ„ÙŠØª', price:65}, {id:'dess_02', name:'ÙˆØ§ÙÙ„ Ù†ÙˆØªÙŠÙ„Ø§', price:75},
      {id:'dess_07', name:'Ù…ÙˆÙ„ØªÙ† ÙƒÙŠÙƒ', price:75}, {id:'dess_08', name:'ØªØ´ÙŠØ² ÙƒÙŠÙƒ', price:85}
  ]},
  special: { title: 'Ù…Ù…ÙŠØ²', items: [
      {id:'sp_02', name:'Ø§Ù†Ø¯ÙˆÙ…ÙŠ', price:20}, {id:'sp_04', name:'ÙƒÙˆÙƒØªÙŠÙ„ Ù†ÙŠÙˆ', price:100}
  ]},
  extras: { title: 'Ø¥Ø¶Ø§ÙØ§Øª', items: [
      {id:'ext_01', name:'ØªØºÙ„ÙŠÙ', price:10}, {id:'ext_02', name:'Ù…ÙŠØ§Ù‡', price:10}
  ]}
};

// State Variables
let currentTable = null;
let tables = JSON.parse(localStorage.getItem('neo_tables')) || {}; // {1: [], 2: []}
let inventory = JSON.parse(localStorage.getItem('neo_inventory')) || [
    {id: 'inv_1', name: 'Ø£ÙƒÙˆØ§Ø¨ ÙˆØ±Ù‚ÙŠØ©', stock: 100, unit: 'Ø¹Ø¯Ø¯'},
    {id: 'inv_2', name: 'Ø¨Ù† Ù‚Ù‡ÙˆØ©', stock: 5000, unit: 'Ø¬Ø±Ø§Ù…'},
    {id: 'inv_3', name: 'Ø­Ù„ÙŠØ¨', stock: 20, unit: 'Ù„ØªØ±'},
    {id: 'inv_4', name: 'Ù…ÙŠØ§Ù‡ Ù…Ø¹Ø¯Ù†ÙŠØ©', stock: 50, unit: 'Ø²Ø¬Ø§Ø¬Ø©'}
];
let recipes = JSON.parse(localStorage.getItem('neo_recipes')) || {}; // {prod_id: {cost: 10, inv_id: 'inv_1', qty: 1}}
let salesLog = JSON.parse(localStorage.getItem('neo_sales')) || [];

// Initialization
function init() {
    renderTables();
    renderCategories();
    renderProducts('ramadan'); // Default cat
    updateDashboard();
    renderInventory();
    renderRecipesTable();
}

// --- 2. POS LOGIC ---
function renderTables() {
    const grid = document.getElementById('tablesGrid');
    grid.innerHTML = '';
    // Generate 12 Tables
    for (let i = 1; i <= 12; i++) {
        const btn = document.createElement('div');
        btn.className = `table-btn ${tables[i] && tables[i].length > 0 ? 'occupied' : ''} ${currentTable == i ? 'selected' : ''}`;
        btn.textContent = `Ø·Ø§ÙˆÙ„Ø© ${i}`;
        if(tables[i] && tables[i].length > 0) {
            const total = tables[i].reduce((a,b)=>a+b.price*b.qty,0);
            btn.innerHTML += `<br><small style="font-size:10px">${total} Ø¬</small>`;
        }
        btn.onclick = () => selectTable(i);
        grid.appendChild(btn);
    }
}

function selectTable(num) {
    currentTable = num;
    document.getElementById('currentTableLabel').textContent = `Ø·Ø§ÙˆÙ„Ø© Ø±Ù‚Ù…: ${num}`;
    renderTables();
    renderCart();
}

function renderCategories() {
    const container = document.getElementById('catTabs');
    Object.keys(MENU_DATA).forEach(key => {
        const div = document.createElement('div');
        div.className = 'cat-tab';
        div.textContent = MENU_DATA[key].title;
        div.onclick = (e) => {
            document.querySelectorAll('.cat-tab').forEach(c=>c.classList.remove('active'));
            e.target.classList.add('active');
            renderProducts(key);
        };
        container.appendChild(div);
    });
}

function renderProducts(catKey) {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = '';
    MENU_DATA[catKey].items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'pos-card';
        div.innerHTML = `
            <img src="assets/images/logo.png" alt="img">
            <h4>${item.name}</h4>
            <span>${item.price} Ø¬</span>
        `;
        div.onclick = () => addToCart(item);
        grid.appendChild(div);
    });
}

function addToCart(item) {
    if (!currentTable) { alert('Ø§Ø®ØªØ§Ø± ØªØ±Ø§Ø¨ÙŠØ²Ø© Ø§Ù„Ø£ÙˆÙ„ ÙŠØ§ Ø¨ÙˆØ¨!'); return; }
    if (!tables[currentTable]) tables[currentTable] = [];
    
    const existing = tables[currentTable].find(i => i.id === item.id);
    if (existing) existing.qty++;
    else tables[currentTable].push({ ...item, qty: 1 });
    
    saveTables();
    renderCart();
    renderTables(); // Update occupancy
}

function renderCart() {
    const container = document.getElementById('cartItems');
    const totalEl = document.getElementById('cartTotal');
    
    if (!currentTable || !tables[currentTable] || tables[currentTable].length === 0) {
        container.innerHTML = '<div style="text-align:center;color:#999;margin-top:20px">ÙØ§Ø¶ÙŠØ©</div>';
        totalEl.textContent = '0.00 Ø¬';
        return;
    }

    let total = 0;
    container.innerHTML = tables[currentTable].map((item, idx) => {
        total += item.price * item.qty;
        return `
            <div class="cart-item">
                <div style="flex:2">${item.name}</div>
                <div style="flex:1;text-align:center">
                    <button onclick="changeQty(${idx}, -1)" style="padding:0 5px">-</button>
                    ${item.qty}
                    <button onclick="changeQty(${idx}, 1)" style="padding:0 5px">+</button>
                </div>
                <div style="flex:1;text-align:left">${item.price * item.qty}</div>
            </div>
        `;
    }).join('');
    totalEl.textContent = total + ' Ø¬';
}

function changeQty(idx, delta) {
    if(!tables[currentTable]) return;
    tables[currentTable][idx].qty += delta;
    if(tables[currentTable][idx].qty <= 0) tables[currentTable].splice(idx, 1);
    saveTables();
    renderCart();
    renderTables();
}

function clearCart() {
    if(!currentTable) return;
    if(confirm('Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø³Ø­ Ø§Ù„Ø·Ù„Ø¨ØŸ')) {
        tables[currentTable] = [];
        saveTables();
        renderCart();
        renderTables();
    }
}

// --- 3. CHECKOUT & PRINT ---
function checkout() {
    if (!currentTable || !tables[currentTable] || tables[currentTable].length === 0) return;

    const orderItems = tables[currentTable];
    const total = orderItems.reduce((a,b) => a + b.price * b.qty, 0);
    const date = new Date().toLocaleString('ar-EG');
    const orderId = Date.now().toString().slice(-6);

    // 1. Calculate Cost & Profit
    let totalCost = 0;
    orderItems.forEach(item => {
        if(recipes[item.id]) {
            totalCost += (recipes[item.id].cost || 0) * item.qty;
            // Deduct Inventory
            const invId = recipes[item.id].inv_id;
            const deductQty = recipes[item.id].deduct_qty;
            if(invId && deductQty) {
                const invItem = inventory.find(x => x.id === invId);
                if(invItem) invItem.stock -= (deductQty * item.qty);
            }
        }
    });
    localStorage.setItem('neo_inventory', JSON.stringify(inventory));
    renderInventory();

    // 2. Save Sale Log
    const saleRecord = {
        id: orderId,
        date: date,
        table: currentTable,
        items: orderItems,
        total: total,
        cost: totalCost,
        profit: total - totalCost
    };
    salesLog.unshift(saleRecord); // Add to top
    localStorage.setItem('neo_sales', JSON.stringify(salesLog));

    // 3. Print
    document.getElementById('r-date').textContent = date;
    document.getElementById('r-id').textContent = 'Order #' + orderId;
    document.getElementById('r-total-price').textContent = total;
    document.getElementById('r-items').innerHTML = orderItems.map(i => 
        `<tr><td style="text-align:right">${i.name}</td><td style="text-align:center">${i.qty}</td><td style="text-align:center">${i.price*i.qty}</td></tr>`
    ).join('');
    
    window.print();

    // 4. Clear Table
    tables[currentTable] = [];
    saveTables();
    renderCart();
    renderTables();
    updateDashboard();
}

// --- 4. INVENTORY LOGIC ---
function renderInventory() {
    const tbody = document.getElementById('inventoryBody');
    tbody.innerHTML = inventory.map(item => `
        <tr>
            <td>${item.name}</td>
            <td style="color:${item.stock < 10 ? 'red' : 'green'}">${item.stock}</td>
            <td>${item.unit}</td>
            <td><input type="number" style="width:60px" onchange="updateStock('${item.id}', this.value)" placeholder="+/-"></td>
            <td><button onclick="deleteInv('${item.id}')" style="color:red;border:none;background:none">X</button></td>
        </tr>
    `).join('');
}

function addRawMaterial() {
    const name = prompt('Ø§Ø³Ù… Ø§Ù„Ø®Ø§Ù…Ø© (Ù…Ø«Ø§Ù„: Ø¨Ù†):');
    if(!name) return;
    const unit = prompt('Ø§Ù„ÙˆØ­Ø¯Ø© (Ù…Ø«Ø§Ù„: Ø¬Ø±Ø§Ù…):', 'Ø¹Ø¯Ø¯');
    const stock = parseFloat(prompt('Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:', 0));
    const id = 'inv_' + Date.now();
    inventory.push({ id, name, unit, stock });
    localStorage.setItem('neo_inventory', JSON.stringify(inventory));
    renderInventory();
    renderRecipesTable(); // Update select boxes
}

function updateStock(id, val) {
    const item = inventory.find(x => x.id === id);
    if(item) {
        item.stock += parseFloat(val);
        localStorage.setItem('neo_inventory', JSON.stringify(inventory));
        renderInventory();
    }
}

// --- 5. RECIPES (CONFIG) LOGIC ---
function renderRecipesTable() {
    const tbody = document.getElementById('recipesBody');
    tbody.innerHTML = '';
    
    // Flatten menu items for list
    let allProducts = [];
    Object.keys(MENU_DATA).forEach(k => allProducts = [...allProducts, ...MENU_DATA[k].items]);

    // Search filter
    const search = document.getElementById('recipeSearch').value.toLowerCase();
    const filtered = allProducts.filter(p => p.name.toLowerCase().includes(search));

    // Inventory Options
    const invOptions = `<option value="">-- Ù„Ø§ ÙŠØ®ØµÙ… --</option>` + 
        inventory.map(i => `<option value="${i.id}">${i.name} (${i.unit})</option>`).join('');

    filtered.forEach(p => {
        const conf = recipes[p.id] || {cost: 0, inv_id: '', deduct_qty: 0};
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${p.name}</td>
            <td>${p.price}</td>
            <td><input type="number" class="cost-in" value="${conf.cost}" style="width:60px"></td>
            <td><select class="inv-sel" style="width:120px">${invOptions}</select></td>
            <td><input type="number" class="qty-in" value="${conf.deduct_qty}" style="width:60px"></td>
            <td><button class="save-btn" style="background:var(--success);color:white;border:none;padding:5px 10px;border-radius:4px">Ø­ÙØ¸</button></td>
        `;
        
        // Set selected value
        row.querySelector('.inv-sel').value = conf.inv_id;
        
        // Save Handler
        row.querySelector('.save-btn').onclick = () => {
            recipes[p.id] = {
                cost: parseFloat(row.querySelector('.cost-in').value) || 0,
                inv_id: row.querySelector('.inv-sel').value,
                deduct_qty: parseFloat(row.querySelector('.qty-in').value) || 0
            };
            localStorage.setItem('neo_recipes', JSON.stringify(recipes));
            alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù„Ù„Ù…Ù†ØªØ¬: ' + p.name);
        };
        tbody.appendChild(row);
    });
}
document.getElementById('recipeSearch').onkeyup = renderRecipesTable;

// --- 6. DASHBOARD & HELPERS ---
function updateDashboard() {
    // Sales Log
    const tbody = document.getElementById('salesLogBody');
    tbody.innerHTML = salesLog.slice(0, 10).map(s => `
        <tr>
            <td>#${s.id}</td>
            <td>${s.date.split(',')[1]}</td>
            <td>${s.table}</td>
            <td>${s.total} Ø¬</td>
            <td>${s.items.map(i=>i.name).join(', ')}</td>
        </tr>
    `).join('');

    // Stats (Calculate Today's totals)
    const today = new Date().toLocaleDateString('ar-EG');
    const todaySales = salesLog.filter(s => s.date.includes(today));
    
    const totalRev = todaySales.reduce((a,b)=>a+b.total, 0);
    const totalProfit = todaySales.reduce((a,b)=>a+(b.profit||0), 0);
    const totalSafe = salesLog.reduce((a,b)=>a+b.total, 0); // All time total

    document.getElementById('todaySales').textContent = totalRev + ' Ø¬';
    document.getElementById('todayOrders').textContent = todaySales.length;
    document.getElementById('todayProfit').textContent = totalProfit + ' Ø¬';
    document.getElementById('safeBalance').textContent = totalSafe + ' Ø¬';
}

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
}

function saveTables() { localStorage.setItem('neo_tables', JSON.stringify(tables)); }

function exportData() {
    let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM for Excel Arabic
    csvContent += "ID,Date,Total,Profit,Items\n";
    salesLog.forEach(row => {
        let items = row.items.map(i=>`${i.name}(${i.qty})`).join(' | ');
        csvContent += `${row.id},${row.date},${row.total},${row.profit},"${items}"\n`;
    });
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "neo_sales_report.csv");
    document.body.appendChild(link);
    link.click();
}

// Start
init();
</script>
</body>
</html>
